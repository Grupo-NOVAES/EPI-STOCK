<!DOCTYPE html>
<html lang="pt-BR" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque de EPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #3b82f6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- O cabeçalho e a navegação permanecem os mesmos -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Controle de Estoque de EPIs</h1>
            <p class="text-gray-600 mt-1">Painel para gerenciar estoque, validade de CAs, entradas e saídas.</p>
        </header>
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-1 md:space-x-4" aria-label="Tabs">
                <button data-tab="dashboard" class="tab-button py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700 active"><i class="fas fa-tachometer-alt mr-2 opacity-75"></i>Dashboard</button>
                <button data-tab="financial" class="tab-button py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700"><i class="fas fa-chart-line mr-2 opacity-75"></i>Análise Financeira</button>
                <button data-tab="history" class="tab-button py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700"><i class="fas fa-history mr-2 opacity-75"></i>Histórico</button>
                <button data-tab="items" class="tab-button py-3 px-2 text-sm font-medium text-gray-500 hover:text-gray-700"><i class="fas fa-box-open mr-2 opacity-75"></i>Gerenciar Itens</button>
            </nav>
        </div>
        <main>
            <div id="loading" class="text-center py-20 hidden"><span class="loader"></span></div>
            <div id="tab-content" class="hidden">
                <!-- As abas (dashboard, financial, history, items) permanecem as mesmas -->
                 <div id="dashboard-tab" class="tab-pane">
                    <div id="dashboard-header" class="flex justify-between items-center mb-4">
                        <h2 id="dashboard-title" class="text-xl font-bold text-gray-700">Categorias</h2>
                        <div>
                            <button id="back-to-categories-btn" class="hidden font-bold py-2 px-4 rounded-lg shadow-md bg-gray-200 hover:bg-gray-300 text-gray-800 mr-4"><i class="fas fa-arrow-left mr-2"></i>Voltar</button>
                            <button id="open-transaction-modal-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-blue-600 hover:bg-blue-700 text-white"><i class="fas fa-plus-circle mr-2"></i>Nova Movimentação</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="stock-container"></div>
                </div>
                <div id="financial-tab" class="tab-pane hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm font-medium text-gray-500">Valor Total do Estoque</p><p id="total-stock-value" class="text-3xl font-bold text-gray-900 mt-1">R$ 0,00</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm font-medium text-gray-500">Item Mais Valioso</p><p id="most-valuable-item" class="text-2xl font-bold text-gray-900 mt-1 truncate">N/A</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm font-medium text-gray-500">Custo Saídas (Mês Atual)</p><p id="monthly-cost" class="text-3xl font-bold text-gray-900 mt-1">R$ 0,00</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md flex flex-col"><h3 class="font-bold mb-4">Valor por Categoria</h3><div class="relative h-64 md:h-80 w-full"><canvas id="category-value-chart"></canvas></div></div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md flex flex-col"><h3 class="font-bold mb-4">Top 5 Itens por Valor em Estoque</h3><div class="relative h-64 md:h-80 w-full"><canvas id="top-items-chart"></canvas></div></div>
                    </div>
                </div>
                <div id="history-tab" class="tab-pane hidden">
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                        <form id="history-filter-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
                            <div><label class="block text-sm font-medium text-gray-700" for="filter-date-start">Data Início</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="date" id="filter-date-start" name="dateStart"></div>
                            <div><label class="block text-sm font-medium text-gray-700" for="filter-date-end">Data Fim</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="date" id="filter-date-end" name="dateEnd"></div>
                            <div><label class="block text-sm font-medium text-gray-700" for="filter-op">Ordem (OP)</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="filter-op" name="op" placeholder="Digite o nº da OP"></div>
                            <div><label class="block text-sm font-medium text-gray-700" for="filter-type">Tipo</label><select id="filter-type" name="type" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"><option value="">Todos</option><option value="Entrada">Entrada</option><option value="Saída">Saída</option></select></div>
                            <div class="flex space-x-2"><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md bg-blue-600 hover:bg-blue-700 text-white">Filtrar</button><button type="button" id="clear-filters-btn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md bg-gray-200 hover:bg-gray-300 text-gray-800">Limpar</button></div>
                        </form>
                    </div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destino / OP</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Un.</th></tr></thead><tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
                <div id="items-tab" class="tab-pane hidden">
                    <div class="flex justify-end mb-4"><button id="open-item-modal-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-green-600 hover:bg-green-700 text-white"><i class="fas fa-plus-circle mr-2"></i>Adicionar Novo Item</button></div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº CA</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th></tr></thead><tbody id="items-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais -->
    <!-- *** MODAL DE TRANSAÇÃO ATUALIZADO *** -->
    <div id="transaction-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex bg-black bg-opacity-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4"><h3 class="text-xl font-bold mb-4 text-gray-800">Nova Movimentação</h3><form id="transaction-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700" for="item-select">Item</label><select id="item-select" name="itemId" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></select></div><div><label class="block text-sm font-medium text-gray-700" for="transaction-type">Tipo</label><select id="transaction-type" name="type" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"><option value="Saída" selected>Saída</option><option value="Entrada">Entrada</option></select></div><div id="price-field-wrapper" class="hidden"><label class="block text-sm font-medium text-gray-700" for="price">Preço Unitário (R$)</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="number" id="price" name="price" placeholder="19.99" step="0.01" min="0"></div><div><label class="block text-sm font-medium text-gray-700" for="quantity">Quantidade</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="number" id="quantity" name="quantity" min="1" required></div><div><label class="block text-sm font-medium text-gray-700" for="date">Data</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="date" id="date" name="date" required></div>
                <!-- Campo OP (para Saídas) -->
                <div id="op-field-wrapper"><label class="block text-sm font-medium text-gray-700" for="op_number">Ordem de Produção (OP)</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="op_number" name="op_number" placeholder="Digite a OP"></div>
                <!-- Campo Fornecedor (para Entradas) -->
                <div id="recipient-field-wrapper" class="hidden"><label class="block text-sm font-medium text-gray-700" for="recipient">Fornecedor</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="recipient" name="recipient" placeholder="Nome do Fornecedor"></div>
            </div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="close-modal-btn font-bold py-2 px-4 rounded-lg shadow-md bg-gray-200 hover:bg-gray-300 text-gray-800">Cancelar</button><button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-blue-600 hover:bg-blue-700 text-white">Salvar</button></div></form></div></div>    
    
    <!-- *** MODAL DE ITEM ATUALIZADO *** -->
    <div id="item-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex bg-black bg-opacity-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4"><h3 id="item-modal-title" class="text-xl font-bold mb-4 text-gray-800">Adicionar Item</h3><form id="item-form" class="space-y-4"><input type="hidden" id="item-id-hidden" name="hiddenId"><div><label class="block text-sm font-medium text-gray-700" for="item-description">Descrição do EPI</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="item-description" name="description" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700" for="item-category">Categoria</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="item-category" name="category" required placeholder="Ex: Calçados"></div>
                <!-- CAMPO DE ID MANUAL REMOVIDO -->
                <div><label class="block text-sm font-medium text-gray-700" for="item-ca-number">Nº do CA</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="item-ca-number" name="caNumber"></div><div><label class="block text-sm font-medium text-gray-700" for="item-ca-validity">Validade do CA</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="date" id="item-ca-validity" name="caValidityDate"></div><div><label class="block text-sm font-medium text-gray-700" for="item-unit">Unidade</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="text" id="item-unit" name="unit" required placeholder="Ex: Un, Par"></div><div><label class="block text-sm font-medium text-gray-700" for="item-min-stock">Estoque Mínimo</label><input class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" type="number" id="item-min-stock" name="minStock" min="0" value="0" required></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="close-modal-btn font-bold py-2 px-4 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800">Cancelar</button><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white">Salvar Item</button></div></form></div></div>

    <script src="./js/api.js" defer></script>
    <script src="./js/ui.js" defer></script>
    <script src="./js/main.js" defer></script>
</body>
</html>
